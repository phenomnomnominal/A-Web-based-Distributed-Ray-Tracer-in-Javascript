<!DOCTYPE html>  <html> <head>   <title>triangle.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               triangle.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><em>triangle.coffee</em> contains the <a href="#mesh"><strong><code>TriangleMesh</code></strong></a> and <a href="#triangle"><strong><code>Triangle</code></strong></a> classes.</p>

<hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Error Types:</h2>

<p>Some specific <strong><code>Error</code></strong> types for these classes:</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><section id='tmce'></section></p>

<ul>
<li><strong><code>TriangleMeshConstructorError</code></strong>:</li>
</ul>

<blockquote>
  <blockquote>
    <p>These errors are thrown when something is wrong in the <a href="#mesh"><strong><code>TriangleMesh</code></strong></a> constructor</p>
  </blockquote>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">TriangleMeshConstructorError</span> <span class="k">extends</span> <span class="nb">Error</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2><section id='mesh'>TriangleMesh:</section></h2>

<hr />

<p>The <strong><code>TriangleMesh</code></strong> class is an extension of the <a href="shape.html#shape"><strong><code>Shape</code></strong></a> class that provides a way to store the data from large numbers of <a href="#triangle"><strong><code>Triangles</code></strong></a> so that their per-vertex data, such as position, normals etc. can be shared among many triangles, in order to save memory.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">TriangleMesh</span> <span class="k">extends</span> <span class="nx">Shape</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3><em>constructor:</em></h3>

<blockquote>
  <p>The <strong><code>TriangleMesh</code></strong> constructor requires the same parameters as the <strong><code>Shape</code></strong> <a href="shape.html#shape-cons"><strong><code>constructor</code></strong></a>.</p>
  
  <p>In addition, it requires several other parameters:</p>
  
  <ul>
  <li><p>The number of <strong><code>Triangles</code></strong> that make up the mesh: <code>numberTriangles</code></p></li>
  <li><p>The number of vertices that make up those <strong><code>Triangles</code></strong>: <code>numberVertices</code></p></li>
  <li><p>The <code>Array</code> of numbers which correspond to the indices of the vertices: <code>vertexIndices</code></p></li>
  <li><p>The <code>Array</code> of vertex positions: <code>positions</code>.</p></li>
  </ul>
  
  <p>If these are not supplied or are of the incorrect type, the constructor will throw a <a href="#tmce"><strong><code>TriangleMeshConstructorError</code></strong></a>.</p>
  
  <p>There are also several optional arguments:</p>
  
  <ul>
  <li><p>An <code>Array</code> of <a href="geometry.html#normal"><strong><code>Normals</code></strong></a>, used to compute shading geometry: <code>normals</code></p></li>
  <li><p>An <code>Array</code> of <a href="geometry.html#vector"><strong><code>Vectors</code></strong></a>, used to compute shading geometry: <code>tangents</code></p></li>
  <li><p>An <code>Array</code> of parameterised (U,V) coordinates, used for intersections and texture mapping: <code>uvs</code></p></li>
  <li><p>A Texture used to remove part of the <strong><code>Triangle</code></strong> surfaces: <code>alphaTexture</code></p></li>
  </ul>
  
  <p>All the constructor arguments are copied before being stored in the <strong><code>TriangleMesh</code></strong> object. This is so that the caller retains ownership of the data that is passed in.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(objectToWorld, worldToObject, reverseOrientation, </span>
<span class="nf">                @numberTriangles, @numberVertices, vertexIndices, positions, </span>
<span class="nf">                normals = [], tangents = [], uvs = [], alphaTexture = null) -&gt;</span>
                  
    <span class="k">super</span><span class="p">(</span><span class="nx">objectToWorld</span><span class="p">,</span> <span class="nx">worldToObject</span><span class="p">,</span> <span class="nx">reverseOrientation</span><span class="p">)</span>
    
    <span class="nx">unless</span> <span class="nx">@numberTriangles</span><span class="o">?</span>
      <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;numberTriangles must be defined.&quot;</span>
    <span class="nx">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span> <span class="nx">@numberTriangles</span>
      <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;numberTriangles must be a Number.&quot;</span>
    <span class="nx">unless</span> <span class="nx">@numberVertices</span><span class="o">?</span>
      <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;numberVertices must be defined.&quot;</span>
    <span class="nx">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span> <span class="nx">@numberVertices</span>
      <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;numberVertices must be a Number.&quot;</span>
    <span class="nx">unless</span> <span class="nx">vertexIndices</span><span class="o">?</span>
      <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;vertexIndices must be defined.&quot;</span>
    <span class="nx">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">vertexIndices</span>
      <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;vertexIndices must be an Array.&quot;</span>
    <span class="nx">unless</span> <span class="nx">positions</span><span class="o">?</span>
      <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;positions must be defined.&quot;</span>
    <span class="nx">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">positions</span>
      <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;positions must be an Array.&quot;</span>
      
    <span class="k">if</span> <span class="nx">normals</span><span class="o">?</span>
      <span class="nx">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">normals</span>
        <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;normals must be an Array.&quot;</span>
    <span class="k">if</span> <span class="nx">tangents</span><span class="o">?</span>
      <span class="nx">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">tangents</span>
        <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;tangents must be an Array.&quot;</span>
    <span class="k">if</span> <span class="nx">uvs</span><span class="o">?</span>
      <span class="nx">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">uvs</span>
        <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;uvs must be an Array.&quot;</span>
        
    <span class="vi">@vertexIndices = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">vi</span> <span class="k">in</span> <span class="nx">vertexIndices</span>
      <span class="nx">@vertexIndices</span><span class="p">.</span><span class="nx">push</span> <span class="nx">vi</span>
    <span class="vi">@positions = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">positions</span>
      <span class="nx">@positions</span><span class="p">.</span><span class="nx">push</span> <span class="nx">Transform</span><span class="p">.</span><span class="nx">TransformPoint</span><span class="p">(</span><span class="nx">objectToWorld</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
    <span class="vi">@normals = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">normals</span>
      <span class="nx">@normals</span><span class="p">.</span><span class="nx">push</span> <span class="nx">Normal</span><span class="p">.</span><span class="nx">Clone</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
    <span class="vi">@tangents = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">tangents</span>
      <span class="nx">@tangents</span><span class="p">.</span><span class="nx">push</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Clone</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
    <span class="vi">@uvs = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">uv</span> <span class="k">in</span> <span class="nx">uvs</span>
      <span class="nx">@uvs</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span><span class="nx">uv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">uv</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="o">`//</span><span class="nv">TODO: triangleMesh.alphaTesture = </span><span class="nx">AlphaTexture</span><span class="p">(</span><span class="nx">alphaTexture</span><span class="p">)</span><span class="o">`</span>
  </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h3><em>objectBound:</em></h3>

<blockquote>
  <p><strong><code>objectBound</code></strong> returns a <a href="geometry.html#bbox"><strong><code>BoundingBox</code></strong></a> of the <strong><code>TriangleMesh</code></strong> in the <strong><code>TriangleMesh</code></strong>'s object-space. This is achieved by first creating an empty <strong><code>BoundingBox</code></strong>, then transforming all of the <a href="geometry.html#point"><strong><code>Points</code></strong></a> in <code>positions</code> with <a href="transform.html#transform-point"><strong><code>Transform.TransformPoint</code></strong></a> and expanding the <strong><code>BoundingBox</code></strong> to encapsulate each one using the <a href="geometry.html#bbox-unionbp"><strong><code>BoundingBox.UnionBBoxAndPoint</code></strong></a> function.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">objectBound: </span><span class="o">-&gt;</span>
    <span class="nv">objectBoundingBox = </span><span class="k">new</span> <span class="nx">BoundingBox</span>
    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@positions</span>
      <span class="nv">transformed = </span><span class="nx">Transform</span><span class="p">.</span><span class="nx">TransformPoint</span> <span class="nx">@worldToObject</span><span class="p">,</span> <span class="nx">p</span>
      <span class="nv">objectBoundingBox = </span><span class="nx">BoundingBox</span><span class="p">.</span><span class="nx">UnionBBoxAndPoint</span> <span class="nx">objectBoundingBox</span><span class="p">,</span> <span class="nx">transformed</span>
    <span class="k">return</span> <span class="nx">objectBoundingBox</span>
  </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h3><em>worldBound:</em></h3>

<blockquote>
  <p><strong><code>worldBound</code></strong> returns a <a href="geometry.html#bbox"><strong><code>BoundingBox</code></strong></a> of the <strong><code>TriangleMesh</code></strong> in the <strong><code>TriangleMesh</code></strong>'s world-space. This is achieved by first creating an empty <strong><code>BoundingBox</code></strong> and expanding the <strong><code>BoundingBox</code></strong> to encapsulate each <a href="geometry.html#point"><strong><code>Point</code></strong></a> is <code>positions</code> using the <a href="geometry.html#bbox-unionbp"><strong><code>BoundingBox.UnionBBoxAndPoint</code></strong></a> function.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">worldBound: </span><span class="o">-&gt;</span>
    <span class="nv">worldBoundingBox = </span><span class="k">new</span> <span class="nx">BoundingBox</span>
    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@positions</span>
      <span class="nv">worldBoundingBox = </span><span class="nx">BoundingBox</span><span class="p">.</span><span class="nx">UnionBBoxAndPoint</span> <span class="nx">worldBoundingBox</span><span class="p">,</span> <span class="nx">p</span>
    <span class="k">return</span> <span class="nx">worldBoundingBox</span>
  </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h3><em>canIntersect:</em></h3>

<blockquote>
  <p><strong><code>canIntersect</code></strong> indicates whether a <strong><code>Shape</code></strong> can compute <a href="geometry.html#ray"><strong><code>Ray</code></strong></a> intersections. Because a <strong><code>TriangleMesh</code></strong> must first be refined into a set of <a href="#triangle"><strong><code>Triangles</code></strong></a>, <code>canIntersect</code> returns <code>no</code>.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">canIntersect: </span><span class="o">-&gt;</span>
    <span class="kc">no</span>
    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h3><em>refine:</em></h3>

<blockquote>
  <p><strong><code>refine</code></strong> is called whenever a <a href="shape.html#shape"><strong><code>Shape</code></strong></a> that cannot be intersected is encountered. It provides the functionality to split the <strong><code>Shape</code></strong> into a group of smaller <strong><code>Shapes</code></strong>, some of which may be intersectable, some that may need further refinement. For <strong><code>TriangleMesh</code></strong>, this involves creating an <code>Array</code> of <a href="#triangle"><strong><code>Triangles</code></strong></a>.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">refine: </span><span class="o">-&gt;</span>
    <span class="nv">triangles = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@numberTriangles</span><span class="p">]</span>
      <span class="nx">triangles</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Triangle</span><span class="p">(</span><span class="nx">@objectToWorld</span><span class="p">,</span> <span class="nx">@worldToObject</span><span class="p">,</span> <span class="nx">@reverseOrientation</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">triangles</span>
    </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2><section id='triangle'>Triangle:</section></h2>

<hr />             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Triangle</span> <span class="k">extends</span> <span class="nx">Shape</span>
  <span class="nv">constructor: </span><span class="nf">(objectToWorld, worldToObject, reverseOrientation, triangleMesh, n) -&gt;</span>
                  
    <span class="k">super</span><span class="p">(</span><span class="nx">objectToWorld</span><span class="p">,</span> <span class="nx">worldToObject</span><span class="p">,</span> <span class="nx">reverseOrientation</span><span class="p">)</span>
    
    <span class="vi">@mesh = </span><span class="nx">triangleMesh</span>
    <span class="vi">@v = </span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">vertexIndices</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="nx">n</span><span class="p">]</span>
    
  <span class="nv">objectBound: </span><span class="o">-&gt;</span>
    <span class="nv">p1 = </span><span class="nx">Transform</span><span class="p">.</span><span class="nx">TransformPoint</span> <span class="nx">@WorldToObject</span><span class="p">,</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span><span class="nx">@v</span><span class="p">]</span>
    <span class="nv">p2 = </span><span class="nx">Transform</span><span class="p">.</span><span class="nx">TransformPoint</span> <span class="nx">@WorldToObject</span><span class="p">,</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="nv">p3 = </span><span class="nx">Transform</span><span class="p">.</span><span class="nx">TransformPoint</span> <span class="nx">@WorldToObject</span><span class="p">,</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">BoundingBox</span><span class="p">.</span><span class="nx">UnionBBoxAndPoint</span> <span class="k">new</span> <span class="nx">BoundingBox</span><span class="p">(</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">),</span> <span class="nx">p3</span>
    
  <span class="nv">worldBound: </span><span class="o">-&gt;</span>
    <span class="nv">p1 = </span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span><span class="nx">@v</span><span class="p">]</span>
    <span class="nv">p2 = </span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="nv">p3 = </span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">BoundingBox</span><span class="p">.</span><span class="nx">UnionBBoxAndPoint</span> <span class="k">new</span> <span class="nx">BoundingBox</span><span class="p">(</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">),</span> <span class="nx">p3</span>
    
  <span class="nv">intersects: </span><span class="nf">(ray) -&gt;</span>
    <span class="nv">p1 = </span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span><span class="nx">@v</span><span class="p">]</span>
    <span class="nv">p2 = </span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="nv">p3 = </span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
    <span class="nv">e1 = </span><span class="nx">Point</span><span class="p">.</span><span class="nx">SubtractPointFromPoint</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">p1</span>
    <span class="nv">e2 = </span><span class="nx">Point</span><span class="p">.</span><span class="nx">SubtractPointFromPoint</span> <span class="nx">p3</span><span class="p">,</span> <span class="nx">p1</span>
    <span class="nv">s1 = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Cross</span> <span class="nx">ray</span><span class="p">.</span><span class="nx">direction</span><span class="p">,</span> <span class="nx">e2</span>
    <span class="nv">divisor = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Dot</span> <span class="nx">s1</span><span class="p">,</span> <span class="nx">e1</span>
    <span class="k">if</span> <span class="nx">divisor</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="nv">invDivisor = </span><span class="mi">1</span> <span class="o">/</span> <span class="nx">divisor</span>
    <span class="nv">d = </span><span class="nx">Point</span><span class="p">.</span><span class="nx">SubtractPointFromPoint</span> <span class="nx">ray</span><span class="p">.</span><span class="nx">origin</span><span class="p">,</span> <span class="nx">p1</span>
    <span class="nv">b1 = </span><span class="nx">invDivisor</span> <span class="o">*</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Dot</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">s1</span>
    <span class="k">if</span> <span class="nx">b1</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">b1</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="nv">s2 = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Cross</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">e1</span>
    <span class="nv">b2 = </span><span class="nx">invDivisor</span> <span class="o">*</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Dot</span> <span class="nx">ray</span><span class="p">.</span><span class="nx">direction</span><span class="p">,</span> <span class="nx">s2</span>
    <span class="k">if</span> <span class="nx">b2</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">b1</span> <span class="o">+</span> <span class="nx">b2</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="nv">t = </span><span class="nx">invDivisor</span> <span class="o">*</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Dot</span> <span class="nx">e2</span><span class="p">,</span> <span class="nx">s2</span>
    <span class="k">if</span> <span class="nx">t</span> <span class="o">&lt;</span> <span class="nx">ray</span><span class="p">.</span><span class="nx">minTime</span> <span class="o">or</span> <span class="nx">t</span> <span class="o">&gt;</span> <span class="nx">ray</span><span class="p">.</span><span class="nx">maxTime</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="k">if</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="o">?</span>
      <span class="nv">uvs = </span><span class="p">[[</span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">@v</span><span class="p">],</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span>
             <span class="p">[</span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span>
             <span class="p">[</span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)],</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]]</span>
    <span class="k">else</span>
      <span class="nv">uvs = </span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
    <span class="nv">du1 = </span><span class="nx">uvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">du2 = </span><span class="nx">uvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">dv1 = </span><span class="nx">uvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="nv">dv2 = </span><span class="nx">uvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="nv">dp1 = </span><span class="nx">Point</span><span class="p">.</span><span class="nx">SubtractPointFromPoint</span> <span class="nx">p1</span><span class="p">,</span> <span class="nx">p3</span>
    <span class="nv">dp2 = </span><span class="nx">Point</span><span class="p">.</span><span class="nx">SubtractPointFromPoint</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">p3</span>
    <span class="nv">determinant = </span><span class="nx">du1</span> <span class="o">*</span> <span class="nx">dv2</span> <span class="o">-</span> <span class="nx">dv1</span> <span class="o">*</span> <span class="nx">du2</span>
    <span class="k">if</span> <span class="nx">determinant</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="p">[</span><span class="nx">normal</span><span class="p">,</span> <span class="nx">dpdu</span><span class="p">,</span> <span class="nx">dpdv</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">CoordinateSystem</span><span class="p">(</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Normalise</span><span class="p">(</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Cross</span><span class="p">(</span><span class="nx">e2</span><span class="p">,</span> <span class="nx">e1</span><span class="p">)))</span>
    <span class="k">else</span>
      <span class="nv">invdet = </span><span class="mi">1</span> <span class="o">/</span> <span class="nx">determinant</span>
      <span class="nv">dpdu = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Multiply</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Subtract</span><span class="p">(</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Multiply</span><span class="p">(</span><span class="nx">dp1</span><span class="p">,</span> <span class="nx">dv2</span><span class="p">),</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Multiply</span><span class="p">(</span><span class="nx">dp2</span><span class="p">,</span> <span class="nx">dv1</span><span class="p">)),</span> <span class="nx">invdet</span>
      <span class="nv">dpdv = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Multiply</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Multiply</span><span class="p">(</span><span class="nx">dp1</span><span class="p">,</span> <span class="o">-</span><span class="nx">du2</span><span class="p">),</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Multiply</span><span class="p">(</span><span class="nx">dp2</span><span class="p">,</span> <span class="nx">du1</span><span class="p">)),</span> <span class="nx">invdet</span>
    <span class="nv">b0 = </span><span class="mi">1</span> <span class="o">-</span> <span class="nx">b1</span> <span class="o">-</span> <span class="nx">b2</span>
    <span class="nv">tu = </span><span class="nx">b0</span> <span class="o">*</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">b1</span> <span class="o">*</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">b2</span> <span class="o">*</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">tv = </span><span class="nx">b0</span> <span class="o">*</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">b1</span> <span class="o">*</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b2</span> <span class="o">*</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="o">`//</span> <span class="nx">TODO</span> <span class="k">if</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">alphaTexture</span><span class="o">`</span>
    <span class="nv">dg = </span><span class="k">new</span> <span class="nx">DifferentialGeometry</span><span class="p">(</span><span class="nx">ray</span><span class="p">.</span><span class="nx">getPoint</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span> <span class="nx">dpdu</span><span class="p">,</span> <span class="nx">dpdv</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="k">new</span> <span class="nx">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">tu</span><span class="p">,</span> <span class="nx">tv</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="kc">true</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">dg</span><span class="p">]</span>
    
    <span class="nv">area = </span><span class="o">-&gt;</span>
      <span class="nv">p1 = </span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span><span class="nx">@v</span><span class="p">]</span>
      <span class="nv">p2 = </span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
      <span class="nv">p3 = </span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">positions</span><span class="p">[</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
      <span class="nv">cross = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Cross</span> <span class="nx">Point</span><span class="p">.</span><span class="nx">SubtractPointFromPoint</span><span class="p">(</span><span class="nx">p2</span><span class="p">,</span> <span class="nx">p1</span><span class="p">),</span> <span class="nx">Point</span><span class="p">.</span><span class="nx">SubtractPointFromPoint</span><span class="p">(</span><span class="nx">p3</span><span class="p">,</span> <span class="nx">p1</span><span class="p">)</span>
      <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">cross</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">cross</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">cross</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">cross</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">cross</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">cross</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span>
      
    <span class="nv">getShadingGeoemtry = </span><span class="nf">(objectToWorld, dg) -&gt;</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">normals</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">tangents</span><span class="o">?</span>
        <span class="k">return</span> <span class="nx">dg</span>
      <span class="k">if</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="o">?</span>
        <span class="nv">uvs = </span><span class="p">[[</span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">@v</span><span class="p">],</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span>
               <span class="p">[</span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span>
               <span class="p">[</span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)],</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]]</span>
      <span class="k">else</span>
        <span class="nv">uvs = </span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
      <span class="nv">A = </span><span class="p">[[</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],[</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nx">uv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span>
      <span class="nv">C = </span><span class="p">[</span><span class="nx">dg</span><span class="p">.</span><span class="nx">u</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">dg</span><span class="p">.</span><span class="nx">v</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
      <span class="p">[</span><span class="nx">solved</span><span class="p">,</span> <span class="nx">b1</span><span class="p">,</span> <span class="nx">b2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MathFunctions</span><span class="p">.</span><span class="nx">SolveLienarSystem2x2</span><span class="p">(</span><span class="nx">A</span><span class="p">,</span> <span class="nx">C</span><span class="p">)</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">solved</span>
        <span class="nv">b0 = b1 = b2 = </span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span>
      <span class="k">else</span>
        <span class="nv">b0 = </span><span class="mi">1</span> <span class="o">-</span> <span class="nx">b1</span> <span class="o">-</span> <span class="nx">b2</span>
      <span class="k">if</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">normals</span><span class="o">?</span>
        <span class="nv">nv1 = </span><span class="nx">Normal</span><span class="p">.</span><span class="nx">Multiply</span><span class="p">(</span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">normals</span><span class="p">[</span><span class="nx">@v</span><span class="p">],</span> <span class="nx">b0</span><span class="p">)</span>
        <span class="nv">nv2 = </span><span class="nx">Normal</span><span class="p">.</span><span class="nx">Multiply</span><span class="p">(</span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">normals</span><span class="p">[</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">b1</span><span class="p">)</span>
        <span class="nv">nv3 = </span><span class="nx">Normal</span><span class="p">.</span><span class="nx">Multiply</span><span class="p">(</span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">normals</span><span class="p">[</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="nx">b2</span><span class="p">)</span>
        <span class="nv">n = </span><span class="nx">Normal</span><span class="p">.</span><span class="nx">Add</span> <span class="nx">Normal</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">nv1</span><span class="p">,</span> <span class="nx">nv2</span><span class="p">),</span> <span class="nx">nv3</span>
        <span class="nv">ns = </span><span class="nx">Normal</span><span class="p">.</span><span class="nx">Normalise</span> <span class="nx">Transform</span><span class="p">.</span><span class="nx">TransformNormal</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
      <span class="k">else</span> 
        <span class="nv">ns = </span><span class="nx">dg</span><span class="p">.</span><span class="nx">nn</span>
      <span class="k">if</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">tangents</span><span class="o">?</span>
        <span class="nv">tv1 = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Multiply</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">tangents</span><span class="p">[</span><span class="nx">@v</span><span class="p">],</span> <span class="nx">b0</span>
        <span class="nv">tv2 = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Multiply</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">tangents</span><span class="p">[</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">b1</span>
        <span class="nv">tv3 = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Multiply</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">tangents</span><span class="p">[</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="nx">b2</span>
        <span class="nv">v = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Add</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">tv1</span><span class="p">,</span> <span class="nx">tv2</span><span class="p">),</span> <span class="nx">tv3</span>
        <span class="nv">ss = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Normalise</span> <span class="nx">Transform</span><span class="p">.</span><span class="nx">TransformVector</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
      <span class="k">else</span> 
        <span class="nv">ss = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Normalise</span> <span class="nx">dg</span><span class="p">.</span><span class="nx">dpdu</span>
      <span class="nv">ts = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Cross</span> <span class="nx">ss</span><span class="p">,</span> <span class="nx">ns</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ts</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">ts</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nv">ts = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Normalise</span> <span class="nx">ts</span>
        <span class="nv">ss = </span><span class="nx">Vector</span><span class="p">.</span><span class="nx">Cross</span> <span class="nx">ts</span><span class="p">,</span> <span class="nx">ns</span>
      <span class="k">else</span>
        <span class="p">[</span><span class="nx">ns</span><span class="p">,</span> <span class="nx">ss</span><span class="p">,</span> <span class="nx">ts</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Vector</span><span class="p">.</span><span class="nx">CoordinateSystem</span> <span class="nx">ns</span>
      <span class="k">if</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">normals</span>
        <span class="k">if</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="o">?</span>
          <span class="nv">uvs = </span><span class="p">[[</span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">@v</span><span class="p">],</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span>
                 <span class="p">[</span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]],</span>
                 <span class="p">[</span><span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)],</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="nx">@v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]]</span>
        <span class="k">else</span>
          <span class="nv">uvs = </span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
        <span class="nv">du1 = </span><span class="nx">uvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">du2 = </span><span class="nx">uvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">dv1 = </span><span class="nx">uvs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">dv2 = </span><span class="nx">uvs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">uvs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="nv">dn1 = </span><span class="nx">Normal</span><span class="p">.</span><span class="nx">Subtract</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">normals</span><span class="p">[</span><span class="nx">v</span><span class="p">],</span> <span class="nx">mesh</span><span class="p">.</span><span class="nx">normals</span><span class="p">[</span><span class="nx">v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="nv">dn2 = </span><span class="nx">Normal</span><span class="p">.</span><span class="nx">Subtract</span> <span class="nx">@mesh</span><span class="p">.</span><span class="nx">normals</span><span class="p">[</span><span class="nx">v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">mesh</span><span class="p">.</span><span class="nx">normals</span><span class="p">[</span><span class="nx">v</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="nv">determinant = </span><span class="nx">du1</span> <span class="o">*</span> <span class="nx">dv2</span> <span class="o">-</span> <span class="nx">dv1</span> <span class="o">*</span> <span class="nx">du2</span><span class="p">;</span>
        <span class="k">if</span> <span class="nx">determinant</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="nv">dndu = dndv = </span><span class="k">new</span> <span class="nx">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">else</span> 
          <span class="nv">invdet = </span><span class="mi">1</span><span class="p">.</span><span class="nx">f</span> <span class="o">/</span> <span class="nx">determinant</span><span class="p">;</span>
          <span class="nv">dndu = </span><span class="nx">Normal</span><span class="p">.</span><span class="nx">Subtract</span><span class="p">(</span><span class="nx">dn1</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">dv2</span><span class="p">),</span> <span class="nx">dn2</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">dv1</span><span class="p">)).</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">invdet</span><span class="p">)</span>
          <span class="nv">dndv = </span><span class="nx">Normal</span><span class="p">.</span><span class="nx">Subtract</span><span class="p">(</span><span class="nx">dn1</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="o">-</span><span class="nx">du2</span><span class="p">),</span> <span class="nx">dn2</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">du1</span><span class="p">)).</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">invdet</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nv">dndu = dndv = </span><span class="k">new</span> <span class="nx">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
      <span class="nv">dgShading = </span><span class="k">new</span> <span class="nx">DifferentialGeometry</span><span class="p">(</span><span class="nx">dg</span><span class="p">.</span><span class="nx">p</span><span class="p">,</span> <span class="nx">ss</span><span class="p">,</span> <span class="nx">ts</span><span class="p">,</span>
          <span class="nx">Transform</span><span class="p">.</span><span class="nx">TransformNormal</span><span class="p">(</span><span class="nx">objectToWorld</span><span class="p">,</span> <span class="nx">dndu</span><span class="p">),</span> <span class="nx">Transform</span><span class="p">.</span><span class="nx">TransformNormal</span><span class="p">(</span><span class="nx">objectToWorld</span><span class="p">,</span> <span class="nx">dndv</span><span class="p">),</span>
          <span class="nx">dg</span><span class="p">.</span><span class="nx">u</span><span class="p">,</span> <span class="nx">dg</span><span class="p">.</span><span class="nx">v</span><span class="p">,</span> <span class="nx">dg</span><span class="p">.</span><span class="nx">shape</span><span class="p">);</span>
      <span class="nv">dgShading.dudx = </span><span class="nx">dg</span><span class="p">.</span><span class="nx">dudx</span><span class="p">;</span>  <span class="nv">dgShading.dvdx = </span><span class="nx">dg</span><span class="p">.</span><span class="nx">dvdx</span>
      <span class="nv">dgShading.dudy = </span><span class="nx">dg</span><span class="p">.</span><span class="nx">dudy</span><span class="p">;</span>  <span class="nv">dgShading.dvdy = </span><span class="nx">dg</span><span class="p">.</span><span class="nx">dvdy</span>
      <span class="nv">dgShading.dpdx = </span><span class="nx">dg</span><span class="p">.</span><span class="nx">dpdx</span><span class="p">;</span>  <span class="nv">dgShading.dpdy = </span><span class="nx">dg</span><span class="p">.</span><span class="nx">dpdy</span>
      <span class="k">return</span> <span class="nx">dgShading</span>
      </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <hr />

<h2>Exports:</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>The <a href="#triangleMesh"><strong><code>TriangleMesh</code></strong></a> and <a href="#triangle"><strong><code>Triangle</code></strong></a> classes are added to the global <code>root</code> object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root = </span><span class="nx">exports</span> <span class="o">?</span> <span class="k">this</span>
<span class="nv">root.TriangleMesh = </span><span class="nx">TriangleMesh</span>
<span class="nv">root.Triangle = </span><span class="nx">Triangle</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 