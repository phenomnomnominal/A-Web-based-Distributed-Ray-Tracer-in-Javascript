<!DOCTYPE html>  <html> <head>   <title>server.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="database.html">                 database.coffee               </a>                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="requestHandlers.html">                 requestHandlers.coffee               </a>                                           <a class="source" href="router.html">                 router.coffee               </a>                                           <a class="source" href="sceneHandler.html">                 sceneHandler.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                                           <a class="source" href="urlShorten.html">                 urlShorten.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><em>server.coffee</em> sets up the server to recieve requests and provide responses, as well as <a href="http://www.websocket.org/"><strong>WebSocket</strong></a> communication with the client.</p>

<hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Requires:</h2>

<p>Functionality in <em>database.coffee</em> requires access to the following <a href="http://nodejs.org/">node.js</a> modules:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <ul>
<li><a href="http://expressjs.com/"><code>express</code></a> - High performance <a href="http://nodejs.org/"><strong>node.js</strong></a> framework</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">express = </span><span class="nx">require</span> <span class="s">&#39;express&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <ul>
<li><a href="http://nodejs.org/api/url.html"><code>url</code></a> - URL resolution and parsing</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">url = </span><span class="nx">require</span> <span class="s">&#39;url&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <ul>
<li><a href="http://socket.io/"><code>io</code></a> - Cross-browser <a href="http://www.websocket.org/"><strong>WebSockets</strong></a> for realtime applications</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">io = </span><span class="nx">require</span> <span class="s">&#39;socket.io&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <ul>
<li><a href="https://github.com/shtylman/node-cookie"><code>cookie</code></a> - Cookie parsing and serialisation</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">cookie = </span><span class="nx">require</span> <span class="s">&#39;cookie&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The <a href="http://www.senchalabs.org/connect/"><code>connect</code></a> <a href="http://www.senchalabs.org/connect/middleware-session.html"><strong><code>Session</code></strong></a> class is also required:</p>

<ul>
<li><strong><code>Session</code></strong> - Session data creation</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Session = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;connect&#39;</span><span class="p">).</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">Session</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h2>Functions:</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h3><section id='init'><em>initialiseServer</em>:</section></h3>

<blockquote>
  <p><strong><code>initialiseServer</code></strong> performs all server configuration, including request handling, session handling and <a href="http://www.websocket.org/"><strong>WebSocket</strong></a> configuration.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">initialiseServer = </span><span class="nf">(route, handle) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <blockquote>
  <p><strong><code>onRequest</code></strong> is called whenever a <code>GET</code> or <code>POST</code> request is received from a client.
  It extracts the filepath, session information, and <code>POST</code> data from the request and forwards the information to the <a href="router.html#route"><strong><code>route</code></strong></a> function.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">onRequest = </span><span class="nf">(request, response) -&gt;</span>
    <span class="nv">pathname = </span><span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">pathname</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">setEncoding</span> <span class="s">&#39;utf8&#39;</span>
    <span class="nx">route</span> <span class="nx">handle</span><span class="p">,</span> <span class="nx">pathname</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">body</span>
  </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <blockquote>
  <p><strong><code>initialiseSocket</code></strong> configures the <a href="http://www.websocket.org/"><strong>WebSocket</strong></a> communication by attaching event listeners for incoming connections from clients. Session data is attached to the created <a href="http://www.websocket.org/"><strong>WebSocket</strong></a> so that messages can be sent to specific clients.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">initialiseSocket = </span><span class="o">-&gt;</span>
    <span class="nx">sio</span><span class="p">.</span><span class="nx">configure</span> <span class="o">-&gt;</span>
      <span class="nx">sio</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;authorization&#39;</span><span class="p">,</span> <span class="nf">(data, accept) -&gt;</span>
        <span class="k">if</span> <span class="nx">data</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span>
          <span class="nv">data.cookie = </span><span class="nx">cookie</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">data</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span>
          <span class="nv">data.sessionID = </span><span class="nx">data</span><span class="p">.</span><span class="nx">cookie</span><span class="p">[</span><span class="s">&#39;express.sid&#39;</span><span class="p">]</span>
          <span class="nv">data.sessionStore = </span><span class="nx">store</span><span class="p">;</span>
          <span class="nx">store</span><span class="p">.</span><span class="nx">get</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sessionID</span><span class="p">,</span> <span class="nf">(err, session) -&gt;</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">or</span> <span class="o">!</span><span class="nx">session</span>
              <span class="nx">accept</span> <span class="s">&#39;Error&#39;</span><span class="p">,</span> <span class="kc">no</span>
            <span class="k">else</span>
              <span class="nv">data.session = </span><span class="k">new</span> <span class="nx">Session</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">session</span><span class="p">)</span>
              <span class="nx">accept</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">yes</span>      
        <span class="k">else</span>
          <span class="nx">accept</span> <span class="s">&#39;No cookie transmitted.&#39;</span><span class="p">,</span> <span class="kc">no</span>
      <span class="nx">sio</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;connection&#39;</span><span class="p">,</span> <span class="nf">(socket) -&gt;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">sio</span><span class="p">.</span><span class="nx">transports</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">name</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;A socket with sessionID </span><span class="si">#{</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="si">}</span><span class="s"> connected!&quot;</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">join</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span> <span class="s">&#39;connected&#39;</span><span class="p">,</span>
          <span class="nv">connection: </span><span class="kc">yes</span>
        <span class="nx">socket</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;confirmConnected&#39;</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">data</span>
      <span class="nx">sio</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;disconnect&#39;</span><span class="p">,</span> <span class="nf">(socket) -&gt;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;A socket with sessionID </span><span class="si">#{</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">sessionID</span><span class="si">}</span><span class="s"> disconnected!&quot;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <blockquote>
  <p>First, the server object is created and <a href="http://socket.io/"><strong>socket.io</strong></a> is pointed towards the server, which is listening for connections on port 3000. A <a href="http://expressjs.com/guide.html#session-support"><strong><code>MemoryStore</code></strong></a> is initialised for session handling.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nv">server = module.exports = </span><span class="nx">express</span><span class="p">.</span><span class="nx">createServer</span><span class="p">()</span>
  <span class="nv">sio = </span><span class="nx">io</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">server</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span> <span class="mi">3000</span>
  <span class="nv">store = </span><span class="k">new</span> <span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">MemoryStore</span>
  </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <blockquote>
  <p>Then <strong>WebSocket</strong> communication is initialised, and the <strong>socket.io</strong> object is attached to the global <em>exports</em> object.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">initialiseSocket</span><span class="p">()</span>
  <span class="nv">server.io = </span><span class="nx">sio</span>
  </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <blockquote>
  <p>Finally the general server configuration is performed.</p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="nx">server</span><span class="p">.</span><span class="nx">configure</span> <span class="o">-&gt;</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;views&#39;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../../views&quot;</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;view engine&#39;</span><span class="p">,</span> <span class="s">&#39;jade&#39;</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">use</span> <span class="s">&#39;/client&#39;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">static</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../client&quot;</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">use</span> <span class="s">&#39;/raytracer&#39;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">static</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../raytracer&quot;</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">use</span> <span class="s">&#39;/testing&#39;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">static</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../testing&quot;</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">use</span> <span class="s">&#39;/libraries&#39;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">static</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../../libraries&quot;</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">use</span> <span class="s">&#39;/stylesheets&#39;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">static</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../../stylesheets&quot;</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">use</span> <span class="s">&#39;/docs&#39;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="nx">static</span> <span class="s">&quot;</span><span class="err">#</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../../docs&quot;</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">logger</span><span class="p">()</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">()</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">cookieParser</span><span class="p">()</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">session</span>
      <span class="nv">secret: </span><span class="s">&#39;phenomnomnominal&#39;</span>
      <span class="nv">key: </span><span class="s">&#39;express.sid&#39;</span>
      <span class="nv">id: </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
      <span class="nv">store: </span><span class="nx">store</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">methodOverride</span><span class="p">()</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">use</span> <span class="nx">server</span><span class="p">.</span><span class="nx">router</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">errorHandler</span>
      <span class="nv">dumpExceptions: </span><span class="kc">true</span>
      <span class="nv">showStack: </span><span class="kc">true</span>
    
  <span class="nx">server</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/*&#39;</span><span class="p">,</span> <span class="nf">(request, response) -&gt;</span>
    <span class="nx">onRequest</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span>

  <span class="nx">server</span><span class="p">.</span><span class="nx">post</span> <span class="s">&#39;/*&#39;</span><span class="p">,</span> <span class="nf">(request, response) -&gt;</span>
    <span class="nx">onRequest</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span>
  
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Server started on port </span><span class="si">#{</span><span class="nx">server</span><span class="p">.</span><span class="nx">address</span><span class="p">().</span><span class="nx">port</span><span class="si">}</span><span class="s"> in </span><span class="si">#{</span><span class="nx">server</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">env</span><span class="si">}</span><span class="s"> mode&quot;</span>   
  </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <hr />

<h2>Exports</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The <a href="#init"><strong><code>initialiseServer</code></strong></a> function is added to the global <code>root</code> object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">root = </span><span class="nx">exports</span> <span class="o">?</span> <span class="k">this</span>
<span class="nv">root.init = </span><span class="nx">initialiseServer</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 